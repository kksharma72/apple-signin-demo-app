<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sign in with Apple</title>
  <meta name="appleid-signin-client-id" content="com.princessauto.dev">
  <meta name="appleid-signin-scope" content="email name">
  <meta name="appleid-signin-redirect-uri" content="https://www-dev.princessauto.com/api/auth/callback/apple">
  <meta name="appleid-signin-state" content="123">
  <meta name="appleid-signin-use-popup" content="true"> <!-- use popup to avoid full redirect -->
  <script src="https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js"></script>
</head>
<body>
  <h1>Sign In with Apple</h1>

  <!-- Apple renders and handles this button -->
  <div id="appleid-signin" data-color="black" data-border="true" data-type="sign-in"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      AppleID.auth.init({
        clientId: 'com.princessauto.dev',
        scope: 'name email',
        redirectURI: 'https://www-dev.princessauto.com/api/auth/callback/apple',
        usePopup: true
      });

      // This is the correct way to handle the sign-in response
      AppleID.auth.signIn().then((response) => {
        const { id_token, code } = response.authorization;

        // The `user` object (email & name) is only present on FIRST login
        const user = response.user;

        console.log("ID Token:", id_token);
        console.log("User:", user);

        // Send the token and user info to backend
        fetch('https://api-dev.princessauto.com/ecom/user/v1/users/social-signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            id_token, 
            user, 
            provider: "apple" 
          })
        })
        .then(res => res.json())
        .then(result => {
          console.log("Backend response:", result);
          // handle accessToken etc.
        });
      }).catch(error => {
        console.error("Apple Sign-in Error:", error);
      });
    });
  </script>
</body>
</html>
